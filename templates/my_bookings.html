{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Bookings | {{ site_name }}</title>
    <link rel="stylesheet" href="{% static 'yourapp/css/homepage.css' %}">
    <link rel="stylesheet" href="{% static 'yourapp/css/react-components.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- React 18 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body, body > main {
            background-color: transparent !important;
        }
        
        .bookings-main {
            min-height: 80vh;
            padding: 120px 20px 60px;
            position: relative;
            z-index: 1;
        }
        
        .bookings-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--white);
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .empty-state svg {
            color: #ccc;
            margin-bottom: 1.5rem;
        }
        
        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
            color: #1a1a1a;
        }
        
        .empty-state p {
            color: #666;
            margin-bottom: 1.5rem;
        }
        
        .booking-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .booking-modal {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
        }
    </style>
</head>
<body>
    <!-- Video Background -->
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden;">
        <video autoplay muted loop playsinline style="position: absolute; top: 50%; left: 50%; min-width: 100%; min-height: 100%; transform: translate(-50%, -50%); object-fit: cover;">
            <source src="{% static 'yourapp/videos/One Minute Real Estate Video Tour.mp4' %}" type="video/mp4">
        </video>
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0.4) 50%, rgba(0,0,0,0.7) 100%);"></div>
    </div>

    <!-- React Header -->
    <div id="react-header" data-active-page="bookings"></div>

    <main class="bookings-main" id="main-content">
        <div class="bookings-container">
            <div class="page-header">
                <h1 class="page-title">My Bookings</h1>
            </div>
            
            <div id="react-bookings-list"></div>
        </div>
    </main>

    <!-- React Footer -->
    <div id="react-footer"></div>
    
    <!-- Site Data -->
    <script>
        window.SITE_DATA = {
            siteName: "{{ site_name|default:'Safe Let Stays' }}",
            contactPhone: "{{ contact_phone|default:'' }}",
            contactEmail: "{{ contact_email|default:'' }}",
            currentPath: "{{ request.path }}",
            isAuthenticated: {{ user.is_authenticated|yesno:"true,false" }}
        };
        
        // Bookings data from Django
        window.BOOKINGS_DATA = [
            {% for booking in bookings %}
            {
                id: {{ booking.id }},
                propertyTitle: "{{ booking.property.title|escapejs }}",
                propertyImage: "{{ booking.property.image.url|default:'' }}",
                checkIn: "{{ booking.check_in|date:'M d, Y' }}",
                checkOut: "{{ booking.check_out|date:'M d, Y' }}",
                guests: {{ booking.guests|default:1 }},
                status: "{{ booking.status|default:'confirmed' }}",
                total: {{ booking.total_price|default:0 }},
                receiptUrl: "{% url 'booking_receipt' booking.id %}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
    </script>
    
    <script type="text/babel" src="{% static 'yourapp/js/react/components.js' %}"></script>
    
    <script type="text/babel">
    {% verbatim %}
        const { useState } = React;
        const { BookingCard, Icons, SiteContext } = window.SafeLetComponents || {};
        
        // Booking Detail Modal
        const BookingDetailModal = ({ booking, onClose }) => {
            if (!booking) return null;
            
            return (
                <div className="booking-modal-overlay" onClick={onClose}>
                    <div className="booking-modal" onClick={(e) => e.stopPropagation()}>
                        <button 
                            onClick={onClose}
                            style={{ position: 'absolute', top: '1rem', right: '1rem', background: '#f5f5f5', border: 'none', borderRadius: '50%', width: '36px', height: '36px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}
                        >
                            <Icons.Close />
                        </button>
                        
                        <h2 style={{ marginBottom: '1.5rem' }}>Booking Details</h2>
                        
                        <div style={{ display: 'flex', gap: '1rem', marginBottom: '1.5rem' }}>
                            <img 
                                src={booking.propertyImage} 
                                alt={booking.propertyTitle}
                                style={{ width: '120px', height: '80px', objectFit: 'cover', borderRadius: '8px' }}
                            />
                            <div>
                                <h3 style={{ marginBottom: '0.25rem' }}>{booking.propertyTitle}</h3>
                                <span className={`booking-status booking-status--${booking.status === 'confirmed' ? 'success' : 'warning'}`}>
                                    {booking.status}
                                </span>
                            </div>
                        </div>
                        
                        <div style={{ background: '#f8f9fa', borderRadius: '8px', padding: '1rem', marginBottom: '1.5rem' }}>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                <div>
                                    <label style={{ fontSize: '0.75rem', color: '#666', textTransform: 'uppercase' }}>Check-in</label>
                                    <p style={{ fontWeight: '600' }}>{booking.checkIn}</p>
                                </div>
                                <div>
                                    <label style={{ fontSize: '0.75rem', color: '#666', textTransform: 'uppercase' }}>Check-out</label>
                                    <p style={{ fontWeight: '600' }}>{booking.checkOut}</p>
                                </div>
                                <div>
                                    <label style={{ fontSize: '0.75rem', color: '#666', textTransform: 'uppercase' }}>Guests</label>
                                    <p style={{ fontWeight: '600' }}>{booking.guests} Guest{booking.guests > 1 ? 's' : ''}</p>
                                </div>
                                <div>
                                    <label style={{ fontSize: '0.75rem', color: '#666', textTransform: 'uppercase' }}>Total</label>
                                    <p style={{ fontWeight: '700', color: 'var(--primary)' }}>Â£{booking.total}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div style={{ display: 'flex', gap: '1rem' }}>
                            <a href={booking.receiptUrl} className="btn btn--primary" style={{ flex: 1, textAlign: 'center' }}>
                                View Receipt
                            </a>
                            <button className="btn btn--outline" onClick={onClose} style={{ flex: 1 }}>
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        // Bookings List Component
        const BookingsList = () => {
            const bookings = window.BOOKINGS_DATA || [];
            const [selectedBooking, setSelectedBooking] = useState(null);
            const isAuthenticated = window.SITE_DATA?.isAuthenticated;
            
            if (!isAuthenticated) {
                return (
                    <div className="empty-state">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        <h3>Sign In to View Your Bookings</h3>
                        <p>Please log in to see your booking history and upcoming stays.</p>
                        <a href="/accounts/login/" className="btn btn--primary">Sign In</a>
                    </div>
                );
            }
            
            if (bookings.length === 0) {
                return (
                    <div className="empty-state">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        <h3>No Bookings Yet</h3>
                        <p>You haven't made any bookings yet. Explore our properties and book your perfect stay!</p>
                        <a href="/properties" className="btn btn--primary">Browse Properties</a>
                    </div>
                );
            }
            
            return (
                <>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                        {bookings.map((booking) => (
                            <BookingCard 
                                key={booking.id} 
                                booking={booking}
                                onClick={() => setSelectedBooking(booking)}
                            />
                        ))}
                    </div>
                    
                    {selectedBooking && (
                        <BookingDetailModal 
                            booking={selectedBooking}
                            onClose={() => setSelectedBooking(null)}
                        />
                    )}
                </>
            );
        };
        
        // Mount component
        const bookingsRoot = document.getElementById('react-bookings-list');
        if (bookingsRoot && window.SafeLetComponents) {
            ReactDOM.createRoot(bookingsRoot).render(
                <SiteContext.Provider value={window.SITE_DATA || {}}>
                    <BookingsList />
                </SiteContext.Provider>
            );
        }
    {% endverbatim %}
    </script>
    
    <script src="{% static 'yourapp/js/homepage.js' %}"></script>
</body>
</html>
